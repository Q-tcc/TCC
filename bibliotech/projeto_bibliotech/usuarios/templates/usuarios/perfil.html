{% extends 'core/base.html' %}
{% load static %}
{% load phone_filters %}

{% block input %}
{% endblock %}

{% block content %}
<div class="profile-page-container">

    <div class="page-header">
        <h1>Perfil</h1>
    </div>


    <div class="profile-card">


        <form method="POST" enctype="multipart/form-data" id="foto-perfil-form">
            {% csrf_token %}
            

            <label for="id_foto_perfil" class="profile-pic-label">
                <div class="profile-pic-container">
                    <img src="{% if usuario.foto_perfil %}{{ usuario.foto_perfil.url }}{% else %}{% static 'images/default_profile.png' %}{% endif %}" 
                         alt="Foto de Perfil" 
                         class="profile-pic"
                         id="profile-pic-preview">
                    <div class="change-photo-overlay">Alterar Foto</div> 
                </div>
            </label>
            

            <div class="hidden-file-input">
                {{ foto_form.foto_perfil }}
            </div>
             

            {% if foto_form.foto_perfil.errors %}
                <div class="form-field-error">{{ foto_form.foto_perfil.errors|first }}</div>
            {% endif %}
        </form> 



        <div class="profile-details-grid">
            
            <div class="profile-column">
                <div class="detail-item">
                    <span class="detail-label">Nome:</span>
                    <span class="detail-value">{{ usuario.first_name }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Sobrenome:</span>
                    <span class="detail-value">{{ usuario.last_name }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Gênero:</span>
                    <span class="detail-value">{{ usuario.get_genero_display|default:"(Não informado)" }}</span>
                </div>
            </div>

            <div class="profile-column">
                <div class="detail-item">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">{{ usuario.email }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Tel:</span>
                    <span class="detail-value">{{ usuario.telefone|phone_format|default:"(Não informado)" }}</span>
                </div>
            
                <div class="detail-item">
                    <span class="detail-label">Livros no total:</span>
                    <span class="detail-value">{{ livros_reservados_count }}</span>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fotoInput = document.getElementById('id_foto_perfil');
        const fotoForm = document.getElementById('foto-perfil-form'); 
        const imagePreview = document.getElementById('profile-pic-preview');

        if (fotoInput && fotoForm) {

            fotoInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if(imagePreview) {
                            imagePreview.src = e.target.result;
                        }
                    }
                    reader.readAsDataURL(file);

                    fotoForm.submit(); 
                }
            });
        }
    });
</script>
{% endblock %}